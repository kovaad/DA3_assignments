---
title: "DA3_Assignment2_AJK"
author: "Adam Kovacs"
date: "1/28/2022"
output: 
  pdf_document:
      fig_caption: true
      latex_engine: xelatex
header-includes: |
  \usepackage{titling}
  \setlength{\droptitle}{-8em}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, eval = TRUE)
```

### Introduction

In this project, I analyze the [****](link) to build predictive models 



```{r import}
#clear memory
rm(list=ls())

#import packages
if (!require(pacman)){
  install.packages("pacman")
}

pacman::p_load(tidyverse, caret, skimr, grid, glmnet, cowplot, modelsummary, fixest, naniar, stringr)

# import data
data <- read_csv("./data/listings.csv") %>% 
  mutate_if(is.character, factor)

```


```{r filtering data}

#filter on 2-6 guests
data <- data %>%
  filter(accommodates %in% seq(2,6,1))

#datasummary(property_type ~ N + Percent(), data = data )
data <- data %>%
  filter(property_type %in% c("Entire rental unit", "Entire serviced apartment",
                              "Entire home/apt", "Private room in rental unit", 
                              "Private room in serviced apartment","Room in rental unit","Room in serviced apartment", "Shared room in rental unit"))

#these are the categories fitting apartments 

#rename variables, create property type as factor
data <- data %>%
  mutate(
    property_type = ifelse(data$property_type == "Entire rental unit" | data$property_type == "Entire serviced apartment" | data$property_type == "Entire home/apt", "Entire apartment", "Room in apartment"),
    f_property_type = factor(property_type))

#datasummary(room_type ~ N + Percent() , data = data )

#there are some hotel rooms - need to be dropped

data <- data %>%
  filter (!room_type %in% c("Hotel room"))

```


```{r feature engineering}

#create room type as factor
data <- data %>%
  mutate(f_room_type = factor(room_type))

# Rename room type because it is too long
data$f_room_type2 <- factor(ifelse(data$f_room_type== "Entire home/apt", "Entire/Apt",
                                   ifelse(data$f_room_type== "Private room", "Private",
                                          ifelse(data$f_room_type== "Shared room", "Shared", "."))))

#create host response time as categorical - first deal with two ways enoded NA
data <- data %>% naniar::replace_with_na(replace = list(host_response_time = 'N/A'))

data <- data %>%
  mutate(f_host_response_time = factor(host_response_time))

#create neighborhood_cleansed as factor - 367 levels
data <- data %>%
  mutate(f_neighbourhood_cleansed = factor(neighbourhood_cleansed))

#create numeric columns
data <- data %>%
  mutate(
    usd_price_day = as.numeric(price),
    p_host_response_rate = as.numeric(host_response_rate),
    p_host_acceptance_rate = as.numeric(host_acceptance_rate),
    c_host_listings_count = as.numeric(host_listings_count)
  )

#deal with bathrooms text - create numeric and factor variable from it
numextract <- function(string){ 
  str_extract(string, "\\-*\\d+\\.*\\d*")
} 

bathrooms_nr = numextract(data$bathrooms_text)

data <- data %>%
     mutate(bathrooms = as.numeric(numextract(bathrooms_text)), 
            bathroom_type = str_trim(str_split_fixed(data$bathrooms_text, bathrooms_nr, n=2)[,2]))

data <- data %>%
     mutate(bathroom_type = ifelse(data$bathroom_type %in% c("bath", "baths"),"bath", ifelse(data$bathroom_type %in% c("shared bath", "shared baths"), "shared", ifelse(data$bathroom_type  == "private bath", "private", NA))))

data <- data %>%
  mutate(f_bathroom_type = factor(bathroom_type))


numericals <- c("accommodates", "bedrooms", "beds", "minimum_nights", "maximum_nights", "availability_30", "availability_60","availability_90","availability_365", "number_of_reviews","number_of_reviews_ltm", "number_of_reviews_l30d", "review_scores_rating", 
                "calculated_host_listings_count", "calculated_host_listings_count_entire_homes", 
                "calculated_host_listings_count_private_rooms", "calculated_host_listings_count_shared_rooms", "reviews_per_month", "bathrooms")


data <- data %>%
  mutate_at(vars(all_of(numericals)), lst("n"=as.numeric))

nnames <- data %>%
  select(ends_with("_n")) %>%
  names()
nnames_i <- match(nnames, colnames(data))
colnames(data)[nnames_i] <- paste0("n_", numericals)


#create days since first review
data <- data %>%
  mutate(
    n_days_since = as.numeric(as.Date(calendar_last_scraped,format="%Y-%m-%d") -
                                as.Date(first_review ,format="%Y-%m-%d")))



#amenities is a list of stuff - use grepl to create dummies

data$essentials <- ifelse(grepl("Essentials",data$amenities),1,0)
data$tv <- ifelse(grepl("TV",data$amenities),1,0)
data$kitchen <- ifelse(grepl("Kitchen",data$amenities),1,0)
data$aircond <- ifelse(grepl("Air conditioning",data$amenities),1,0)
data$hairdry <- ifelse(grepl("Hair dryer",data$amenities),1,0)
data$heating <- ifelse(grepl("Heating",data$amenities),1,0)
data$hotwater <- ifelse(grepl("Hot water",data$amenities),1,0)
data$wifi <- ifelse(grepl("Wifi",data$amenities),1,0)
data$iron <- ifelse(grepl("Iron",data$amenities),1,0)
data$washer <- ifelse(grepl("Washer",data$amenities),1,0)
data$hangers <- ifelse(grepl("Hangers",data$amenities),1,0)
data$longterm <- ifelse(grepl("Long term stays allowed",data$amenities),1,0)
data$balcony <- ifelse(grepl("Patio or balcony",data$amenities),1,0)
data$parking <- ifelse(grepl("Free parking",data$amenities),1,0)
data$parking <- ifelse(grepl("Paid parking",data$amenities),1,0)
data$beachfront <- ifelse(grepl("Beachfront",data$amenities),1,0)
data$freezer <- ifelse(grepl("Freezer|Refrigerator",data$amenities),1,0)
data$kettle <- ifelse(grepl("Hot water kettle",data$amenities),1,0)
data$linens <- ifelse(grepl("Bed linens",data$amenities),1,0)
data$stove <- ifelse(grepl("Stove",data$amenities),1,0)
data$oven <- ifelse(grepl("Oven",data$amenities),1,0)
data$pool <- ifelse(grepl("Pool",data$amenities),1,0)
data$pillows <- ifelse(grepl("Extra pillows and blankets",data$amenities),1,0)
data$fireplace <- ifelse(grepl("Indoor fireplace",data$amenities),1,0)
data$microwave <- ifelse(grepl("Microwave",data$amenities),1,0)
data$workspace <- ifelse(grepl("Dedicated workspace",data$amenities),1,0)
data$cooking <- ifelse(grepl("Cooking basics",data$amenities),1,0)
data$dishes <- ifelse(grepl("Dishes and silverware",data$amenities),1,0)
data$coffee <- ifelse(grepl("Coffee maker",data$amenities),1,0)
data$hostgreets <- ifelse(grepl("Host greets you",data$amenities),1,0)
data$firstaid <- ifelse(grepl("First aid kit",data$amenities),1,0)
data$crib <- ifelse(grepl("Crib",data$amenities),1,0)
data$tub <- ifelse(grepl("Bathtub",data$amenities),1,0)
data$shades <- ifelse(grepl("Room-darkening shades",data$amenities),1,0)
data$backyard <- ifelse(grepl("Backyard",data$amenities),1,0)
data$elevator <- ifelse(grepl("Elevator",data$amenities),1,0)
data$bidet <- ifelse(grepl("Bidet",data$amenities),1,0)
data$wineglass <- ifelse(grepl("Wine glasses",data$amenities),1,0)
data$highchair <- ifelse(grepl("High chair",data$amenities),1,0)
data$bbq <- ifelse(grepl("BBQ grill",data$amenities),1,0)
data$smoke <- ifelse(grepl("Smoke alarm",data$amenities),1,0)
data$luggage <- ifelse(grepl("Luggage dropoff allowed",data$amenities),1,0)
data$toys <- ifelse(grepl("Children\\u2019s books and toys",data$amenities),1,0)


# create dummy vars
dummies <- c("host_identity_verified", "host_is_superhost", "host_has_profile_pic", "has_availability", "instant_bookable")

#these are booleans

#dummies <- names(data)[seq(73,122)]


data <- data %>%
  mutate_at(vars(dummies), funs("d"= (.)))
# rename columns
dnames <- data %>%
  select(ends_with("_d")) %>%
  names()
dnames_i <- match(dnames, colnames(data))
colnames(data)[dnames_i] <- paste0("d_", tolower(gsub("[^[:alnum:]_]", "",dummies)))

# keep columns if contain d_, n_,f_, p_, usd_ and some others
data <- data %>%
  select(matches("^d_.*|^n_.*|^f_.*|^p_.*|^usd_.*"), price, id,
         neighbourhood_cleansed,cancellation_policy,room_type,property_type)

```


```{r target engineering}

datasummary( usd_price_day ~ Mean + Median + Min + Max + P25 + P75, data = data )

#maybe take log
data <- data %>%
  mutate(ln_usd_price_day = log(usd_price_day))

#maybe filter
data <- data %>%
  filter(price <1000)

```

```{r functional forms}
# Squares and further values to create
data <- data %>%
  mutate(n_accommodates2=n_accommodates^2, 
         ln_accommodates=log(n_accommodates) ,
         ln_accommodates2=log(n_accommodates)^2,
         ln_beds = log(n_beds),
         ln_number_of_reviews = log(n_number_of_reviews+1)
        )


```

